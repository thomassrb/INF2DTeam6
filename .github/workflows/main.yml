name: CD - Deploy (self-hosted)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy locally
        run: |
            set -e
            TARGET_DIR="/home/ubuntu-1056396/mobypark"
        
            # Stop service zodat files niet "locked" zijn
            sudo systemctl stop mobypark || true
        
            rsync -az \
              --exclude='.git' \
              --exclude='.github' \
              --exclude='__pycache__' \
              --exclude='venv/' \
              --exclude='.venv/' \
              --exclude='tests/e2e_backup/' \
              ./ "$TARGET_DIR/"
        
            cd "$TARGET_DIR"
        
            if [ -f deploy.sh ]; then
              chmod +x deploy.sh
              ./deploy.sh
            fi
        
            sudo systemctl start mobypark
            sudo systemctl status mobypark --no-pager -l | tail -n 30
