name: CD - Deploy (self-hosted)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy locally
        run: |
          set -e
          TARGET_DIR="/home/ubuntu-1056396/mobypark"

          rsync -az --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='__pycache__' \
            ./ "$TARGET_DIR/"

          cd "$TARGET_DIR"

          if [ -f deploy.sh ]; then
            chmod +x deploy.sh
            ./deploy.sh
          fi

          sudo systemctl restart mobypark
          sudo systemctl status mobypark --no-pager -l | tail -n 30
